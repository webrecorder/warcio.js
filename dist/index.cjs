"use strict";var ce=Object.create;var z=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var ue=Object.getOwnPropertyNames;var fe=Object.getPrototypeOf,pe=Object.prototype.hasOwnProperty;var ye=(a,s)=>{for(var e in s)z(a,e,{get:s[e],enumerable:!0})},Y=(a,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of ue(s))!pe.call(a,r)&&r!==e&&z(a,r,{get:()=>s[r],enumerable:!(t=he(s,r))||t.enumerable});return a};var T=(a,s,e)=>(e=a!=null?ce(fe(a)):{},Y(s||!a||!a.__esModule?z(e,"default",{value:a,enumerable:!0}):e,a)),ge=a=>Y(z({},"__esModule",{value:!0}),a);var Le={};ye(Le,{AsyncIterReader:()=>c,BaseAsyncIterReader:()=>h,CDXAndRecordIndexer:()=>F,CDXIndexer:()=>W,Indexer:()=>H,LimitReader:()=>m,NoConcatInflator:()=>b,StatusAndHeaders:()=>_,StatusAndHeadersParser:()=>S,StreamingWARCSerializer:()=>B,WARCParser:()=>w,WARCRecord:()=>p,WARCRecordBuffer:()=>D,WARCSerializer:()=>A,WARC_1_0:()=>O,WARC_1_1:()=>Q,appendRequestQuery:()=>q,concatChunks:()=>f,getSurt:()=>L,jsonToQueryParams:()=>N,jsonToQueryString:()=>U,mfdToQueryParams:()=>$,mfdToQueryString:()=>j,postToGetUrl:()=>P,splitChunk:()=>R});module.exports=ge(Le);var ee=T(require("pako"),1);function Z(a){let s;typeof a=="string"?s=a:a&&a.length?s=a.reduce((e,t)=>(e+=String.fromCharCode(t),e),""):a?s=a.toString():s="";try{return"__wb_post_data="+btoa(s)}catch{return"__wb_post_data="}}function Re(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function L(a){try{if(!a.startsWith("https:")&&!a.startsWith("http:"))return a;a=a.replace(/^(https?:\/\/)www\d*\./,"$1");let s=a.toLowerCase(),e=new URL(s),r=e.hostname.split(".").reverse().join(",");if(e.port&&(r+=":"+e.port),r+=")",r+=e.pathname,e.search){e.searchParams.sort(),r+=e.search;for(let[n,i]of e.searchParams.entries())if(!i){let o=new RegExp(`(?<=[&?])${Re(n)}=(?=&|$)`);o.exec(s)||(r=r.replace(o,n))}}return r}catch{return a}}function P(a){let{method:s,headers:e,postData:t}=a;if(s==="GET")return!1;let r=(e.get("content-type")||"").split(";")[0];function n(o){return o instanceof Uint8Array&&(o=new TextDecoder().decode(o)),o}let i="";switch(r){case"application/x-www-form-urlencoded":i=n(t);break;case"application/json":i=U(n(t));break;case"text/plain":try{i=U(n(t),!1)}catch{i=Z(t)}break;case"multipart/form-data":{let o=e.get("content-type");if(!o)throw new Error("utils cannot call postToGetURL when missing content-type header");i=j(n(t),o);break}default:i=Z(t)}return i!==null?(a.url=q(a.url,i,a.method),a.method="GET",a.requestBody=i,!0):!1}function q(a,s,e){if(!e)return a;let t=a.indexOf("?")>0?"&":"?";return`${a}${t}__wb_method=${e}&${s}`}function N(a,s=!0){if(typeof a=="string")try{a=JSON.parse(a)}catch{a={}}let e=new URLSearchParams,t={},r=n=>e.has(n)?(n in t||(t[n]=1),n+"."+ ++t[n]+"_"):n;try{JSON.stringify(a,(n,i)=>(["object","function"].includes(typeof i)||e.set(r(n),i),i))}catch(n){if(!s)throw n}return e}function $(a,s){let e=new URLSearchParams;a instanceof Uint8Array&&(a=new TextDecoder().decode(a));try{let t=s.split("boundary=")[1],r=a.split(new RegExp("-*"+t+"-*","mi"));for(let n of r){let i=n.trim().match(/name="([^"]+)"\r\n\r\n(.*)/im);i&&e.set(i[1],i[2])}}catch{}return e}function U(a,s=!0){return N(a,s).toString()}function j(a,s){return $(a,s).toString()}function f(a,s){if(a.length===1)return a[0];let e=new Uint8Array(s),t=0;for(let r of a)e.set(r,t),t+=r.byteLength;return e}function R(a,s){return[a.slice(0,s),a.slice(s)]}var te=new TextDecoder("utf-8"),b=class extends ee.default.Inflate{constructor(e,t){super(e);this.ended=!1;this.chunks=[];this.reader=t}onEnd(e){this.err=e,this.err||(this.reader._rawOffset+=this.strm.total_in)}},h=class{static async readFully(s){let e=[],t=0;for await(let r of s)e.push(r),t+=r.byteLength;return f(e,t)}getReadableStream(){let s=this[Symbol.asyncIterator]();return new ReadableStream({pull(e){return s.next().then(t=>{t.done||!t.value?e.close():e.enqueue(t.value)})}})}async readFully(){return await h.readFully(this)}async readline(s=0){let e=await this.readlineRaw(s);return e?te.decode(e):""}async*iterLines(s=0){let e=null;for(;e=await this.readline(s);)yield e}};function me(a){return a&&Symbol.iterator in Object(a)}function we(a){return a&&Symbol.asyncIterator in Object(a)}var c=class extends h{constructor(e,t="gzip",r=!1){super();this.compressed=t,this.opts={raw:t==="deflateRaw"},this.inflator=t?new b(this.opts,this):null;let n;if(we(e))n=e;else if(typeof e=="object"&&"read"in e&&typeof e.read=="function")n=c.fromReadable(e);else if(e instanceof ReadableStream)n=c.fromReadable(e.getReader());else if(me(e))n=c.fromIter(e);else throw new TypeError("Invalid Stream Source");r?this._sourceIter=this.dechunk(n):this._sourceIter=n[Symbol.asyncIterator](),this.lastValue=null,this.errored=!1,this._savedChunk=null,this._rawOffset=0,this._readOffset=0,this.numChunks=0}async _loadNext(){let e=await this._sourceIter.next();return e.done?null:e.value}async*dechunk(e){let t=e instanceof c?e:new c(e,null),r=-1,n=!0;for(;r!=0;){let i=await t.readlineRaw(64),o=new Uint8Array;if(r=i?parseInt(te.decode(i),16):0,!r||r>2**32){if(Number.isNaN(r)||r>2**32){n||(this.errored=!0),yield i;break}}else if(o=await t.readSize(r),o.length!=r){n?yield i:this.errored=!0,yield o;break}let l=await t.readSize(2);if(l[0]!=13||l[1]!=10){n?yield i:this.errored=!0,yield o,yield l;break}else{if(n=!1,!o||r===0)return;yield o}}yield*t}unread(e){!e.length||(this._readOffset-=e.length,this._savedChunk&&console.log("Already have chunk!"),this._savedChunk=e)}async _next(){if(this._savedChunk){let t=this._savedChunk;return this._savedChunk=null,t}if(this.compressed){let t=this._getNextChunk();if(t)return t}let e=await this._loadNext();for(;this.compressed&&e;){this._push(e);let t=this._getNextChunk(e);if(t)return t;e=await this._loadNext()}return e}_push(e){if(!this.inflator)throw new Error("AsyncIterReader cannot call _push when this.compressed is null");this.lastValue=e,this.inflator.ended&&(this.inflator=new b(this.opts,this)),this.inflator.push(e),this.inflator.err&&this.inflator.ended&&this.compressed==="deflate"&&this.opts.raw===!1&&this.numChunks===0&&(this.opts.raw=!0,this.compressed="deflateRaw",this.inflator=new b(this.opts,this),this.inflator.push(e))}_getNextChunk(e){if(!this.inflator)throw new Error("AsyncIterReader cannot call _getNextChunk when this.compressed is null");for(;;){if(this.inflator.chunks.length>0)return this.numChunks++,this.inflator.chunks.shift();if(this.inflator.ended){if(this.inflator.err!==0)return this.compressed=null,e;let t=this.inflator.strm.avail_in;if(t&&this.lastValue){this._push(this.lastValue.slice(-t));continue}}return null}}async*[Symbol.asyncIterator](){let e=null;for(;e=await this._next();)this._readOffset+=e.length,yield e}async readlineRaw(e){let t=[],r=0,n=-1,i=null;for await(let o of this){if(e&&r+o.byteLength>e){i=o,n=e-r-1;let l=o.slice(0,n+1).indexOf(10);l>=0&&(n=l);break}if(n=o.indexOf(10),n>=0){i=o;break}t.push(o),r+=o.byteLength}if(i){let[o,l]=R(i,n+1);t.push(o),r+=o.byteLength,this.unread(l)}else if(!t.length)return null;return f(t,r)}async readFully(){return(await this._readOrSkip())[1]}async readSize(e){return(await this._readOrSkip(e))[1]}async skipSize(e){return(await this._readOrSkip(e,!0))[0]}async _readOrSkip(e=-1,t=!1){let r=[],n=0;for await(let i of this){if(e>=0)if(i.length>e){let[o,l]=R(i,e);t||r.push(o),n+=o.byteLength,this.unread(l);break}else if(i.length===e){t||r.push(i),n+=i.byteLength,e=0;break}else e-=i.length;t||r.push(i),n+=i.byteLength}return t?[n,new Uint8Array]:[n,f(r,n)]}getReadOffset(){return this._readOffset}getRawOffset(){return this.compressed?this._rawOffset:this._readOffset}getRawLength(e){return this.compressed?this.inflator.strm.total_in:this._readOffset-e}static fromReadable(e){return{async*[Symbol.asyncIterator](){let r=null;for(;(r=await e.read())&&!r.done;)yield r.value}}}static fromIter(e){return{async*[Symbol.asyncIterator](){for(let r of e)yield r}}}},m=class extends h{constructor(e,t,r=0){super();this.sourceIter=e,this.length=t,this.limit=t,this.skip=r}setLimitSkip(e,t=0){this.limit=e,this.skip=t}async*[Symbol.asyncIterator](){if(!(this.limit<=0))for await(let e of this.sourceIter){if(this.skip>0)if(e.length>=this.skip){let[,t]=R(e,this.skip);e=t,this.skip=0}else{this.skip-=e.length;continue}if(e.length>this.limit){let[t,r]=R(e,this.limit);e=t,this.sourceIter.unread&&this.sourceIter.unread(r)}if(e.length&&(this.limit-=e.length,yield e),this.limit<=0)break}}async readlineRaw(e){if(this.limit<=0)return null;let t=await this.sourceIter.readlineRaw(e?Math.min(e,this.limit):this.limit);return this.limit-=t?.length||0,t}async skipFully(){let e=this.limit;for(;this.limit>0;)this.limit-=await this.sourceIter.skipSize(this.limit);return e}};var v=new Uint8Array([13,10]),M=new Uint8Array([13,10,13,10]),Ae=new TextDecoder("utf-8"),_=class{constructor({statusline:s,headers:e}){this.statusline=s,this.headers=e}toString(){let s=[this.statusline];for(let[e,t]of this.headers)s.push(`${e}: ${t}`);return s.join(`\r
`)+`\r
`}async*iterSerialize(s){yield s.encode(this.statusline),yield v;for(let[e,t]of this.headers)yield s.encode(`${e}: ${t}\r
`)}_parseResponseStatusLine(){let s=Ce(this.statusline," ",2);this._protocol=s[0]??"",this._statusCode=s.length>1?Number(s[1]):"",this._statusText=s.length>2?s[2]:""}get statusCode(){return this._statusCode===void 0&&this._parseResponseStatusLine(),this._statusCode}get protocol(){return this._protocol===void 0&&this._parseResponseStatusLine(),this._protocol}get statusText(){return this._statusText===void 0&&this._parseResponseStatusLine(),this._statusText}_parseRequestStatusLine(){let s=this.statusline.split(" ",2);this._method=s[0]??"",this._requestPath=s.length>1?s[1]:""}get method(){return this._method===void 0&&this._parseRequestStatusLine(),this._method}get requestPath(){return this._requestPath===void 0&&this._parseRequestStatusLine(),this._requestPath}},S=class{async parse(s,{headersClass:e,firstLine:t}={headersClass:Map}){let r=t||await s.readline();if(!r)return null;let n=r.trimEnd();if(!n)return null;let i=new e,o=await be(s),l=0,d,y,g,I="",u;for(;l<o.length;){if(g=o.indexOf(`
`,l),u&&(o[l]===" "||o[l]==="	"))u+=o.slice(l,g<0?void 0:g).trimEnd();else{if(u){try{i.set(I,u)}catch{}u=null}d=o.indexOf(":",l),y=d<0?l:d+1,d>=0&&d<g?(I=o.slice(l,d).trimStart(),u=o.slice(y,g<0?void 0:g).trim()):u=null}if(g<0)break;l=g+1}if(u)try{i.set(I,u)}catch{}return new _({statusline:n,headers:i})}};function Ce(a,s,e){let t=a.split(s),r=t.slice(0,e);return t.slice(e).length>0&&r.push(t.slice(e).join(s)),r}async function _e(a,s){let e=0;for(let t=0;t<a.length-4;t++){let r=a.indexOf(13,e);if(r<0)break;if(r+3>=a.length){let{value:n}=await s.next();if(!n)break;let i=new Uint8Array(n.length+a.length);i.set(a,0),i.set(n,a.length),a=i}if(a[r+1]===10&&a[r+2]===13&&a[r+3]===10)return[r+3,a];e=r+1}return[-1,a]}async function be(a){let s=[],e=0,t=0,r=null,n=a[Symbol.asyncIterator]();for await(let i of n){if([t,i]=await _e(i,n),t>=0){r=i;break}s.push(i),e+=i.byteLength}if(r){let[i,o]=R(r,t+1);s.push(i),e+=i.byteLength,a.unread(o)}else if(!s.length)return"";return Ae.decode(f(s,e))}var re=T(require("uuid-random"),1);var xe=new TextDecoder("utf-8"),Se=new TextEncoder,Q="WARC/1.1",O="WARC/1.0",ke="http://netpreserve.org/warc/1.0/revisit/identical-payload-digest",He="http://netpreserve.org/warc/1.1/revisit/identical-payload-digest",We={warcinfo:"application/warc-fields",response:"application/http; msgtype=response",revisit:"application/http; msgtype=response",request:"application/http; msgtype=request",metadata:"application/warc-fields"},p=class extends h{constructor({warcHeaders:e,reader:t}){super();this._offset=0;this._length=0;this.method="";this.requestBody="";this._urlkey="";this.warcHeaders=e,this._reader=t,this._contentReader=null,this.payload=null,this.httpHeaders=null,this.consumed="",this.fixUp()}static create({url:e,date:t,type:r,warcHeaders:n={},filename:i="",httpHeaders:o={},statusline:l="HTTP/1.1 200 OK",warcVersion:d=O,keepHeadersCase:y=!0,refersToUrl:g=void 0,refersToDate:I=void 0}={},u){function E(x){let de=x;return d===O&&(x=x.split(".")[0],x.charAt(de.length-1)!="Z"&&(x+="Z")),x}t=E(t||new Date().toISOString()),n={...n},r==="warcinfo"?i&&(n["WARC-Filename"]=i):n["WARC-Target-URI"]=e,n["WARC-Date"]=t,n["WARC-Type"]=r,r==="revisit"&&(n["WARC-Profile"]=d===Q?He:ke,n["WARC-Refers-To-Target-URI"]=g,n["WARC-Refers-To-Date"]=E(I||new Date().toISOString())),n=new _({statusline:d,headers:y?new Map(Object.entries(n)):new Headers(n)}),n.headers.get("WARC-Record-ID")||n.headers.set("WARC-Record-ID",`<urn:uuid:${(0,re.default)()}>`),n.headers.get("Content-Type")||n.headers.set("Content-Type",r&&We[r]||"application/octet-stream"),u||(u=async function*(){}());let V=new p({warcHeaders:n,reader:u}),K=null,G=[];switch(r){case"response":case"request":case"revisit":G=Object.entries(o),K=y?new Map(G):new Headers(o),(G.length>0||r!=="revisit")&&(V.httpHeaders=new _({statusline:l,headers:K}));break}return V}static createWARCInfo(e={},t){async function*r(){for(let[n,i]of Object.entries(t))yield Se.encode(`${n}: ${i}\r
`)}return e.type="warcinfo",p.create(e,r())}getResponseInfo(){let e=this.httpHeaders;return e?{headers:e.headers,status:e.statusCode,statusText:e.statusText}:null}fixUp(){let e=this.warcHeaders.headers.get("WARC-Target-URI");e&&e.startsWith("<")&&e.endsWith(">")&&this.warcHeaders.headers.set("WARC-Target-URI",e.slice(1,-1))}async readFully(e=!1){if(this.httpHeaders){if(this.payload&&!this.payload.length)return this.payload;if(this._contentReader&&!e)throw new TypeError("WARC Record decoding already started, but requesting raw payload");if(e&&this.consumed==="raw"&&this.payload)return await this._createDecodingReader([this.payload]).readFully()}return this.payload?this.payload:(e?(this.payload=await super.readFully(),this.consumed="content"):(this.payload=await p.readFully(this._reader),this.consumed="raw"),this.payload)}get reader(){if(this._contentReader)throw new TypeError("WARC Record decoding already started, but requesting raw payload");return this._reader}get contentReader(){return this.httpHeaders?(this._contentReader||(this._contentReader=this._createDecodingReader(this._reader)),this._contentReader):this._reader}_createDecodingReader(e){if(!this.httpHeaders)throw new Error("WARCRecord cannot call _createDecodingReader when this.httpHeaders === null");let t=this.httpHeaders.headers.get("Content-Encoding"),r=this.httpHeaders.headers.get("Transfer-Encoding"),n=r==="chunked";return!t&&!n&&(t=r),new c(e,t,n)}async readlineRaw(e){if(this.consumed)throw new Error("Record already consumed.. Perhaps a promise was not awaited?");if(this.contentReader instanceof h)return this.contentReader.readlineRaw(e);throw new Error("WARCRecord cannot call readlineRaw on this.contentReader if it does not extend BaseAsyncIterReader")}async contentText(){let e=await this.readFully(!0);return xe.decode(e)}async*[Symbol.asyncIterator](){for await(let e of this.contentReader)if(yield e,this.consumed)throw new Error("Record already consumed.. Perhaps a promise was not awaited?");this.consumed="content"}async skipFully(){if(!this.consumed){if(this._reader instanceof m){let e=await this._reader.skipFully();return this.consumed="skipped",e}throw new Error("WARCRecord cannot call skipFully on this._reader if it is not a LimitReader")}}warcHeader(e){return this.warcHeaders.headers.get(e)}get warcType(){return this.warcHeaders.headers.get("WARC-Type")}get warcTargetURI(){return this.warcHeaders.headers.get("WARC-Target-URI")}get warcDate(){return this.warcHeaders.headers.get("WARC-Date")}get warcRefersToTargetURI(){return this.warcHeaders.headers.get("WARC-Refers-To-Target-URI")}get warcRefersToDate(){return this.warcHeaders.headers.get("WARC-Refers-To-Date")}get warcPayloadDigest(){return this.warcHeaders.headers.get("WARC-Payload-Digest")}get warcBlockDigest(){return this.warcHeaders.headers.get("WARC-Block-Digest")}get warcContentType(){return this.warcHeaders.headers.get("Content-Type")}get warcContentLength(){return Number(this.warcHeaders.headers.get("Content-Length"))}};var se=new TextDecoder,X=new Uint8Array([]),w=class{static parse(s,e){return new w(s,e).parse()}static iterRecords(s,e){return new w(s,e)[Symbol.asyncIterator]()}constructor(s,{keepHeadersCase:e=!1,parseHttp:t=!0}={}){this._offset=0,this._warcHeadersLength=0,this._headersClass=e?Map:Headers,this._parseHttp=t,s instanceof c?this._reader=s:this._reader=new c(s),this._record=null}async readToNextRecord(){if(!this._reader||!this._record)return X;await this._record.skipFully(),this._reader.compressed&&(this._offset=this._reader.getRawOffset());let s=await this._reader.readlineRaw(),e=0;if(!s)s=X;else{if(e=s.byteLength-1,e===9&&se.decode(s).startsWith("WARC/"))return s;for(;e>0;){let t=s[e-1];if(t!==10&&t!==13)break;e--}e&&console.warn(`Content-Length Too Small: Record not followed by newline, Remainder Length: ${e}, Offset: ${this._reader.getRawOffset()-s.byteLength}`)}if(this._reader.compressed)await this._reader.skipSize(2),s=X;else{for(s=await this._reader.readlineRaw();s&&s.byteLength===2;)s=await this._reader.readlineRaw();this._offset=this._reader.getRawOffset(),s&&(this._offset-=s.length)}return s}_initRecordReader(s){return new m(this._reader,Number(s.headers.get("Content-Length")||0))}async parse(){let s=await this.readToNextRecord(),e=s?se.decode(s):"",t=new S,r=await t.parse(this._reader,{firstLine:e,headersClass:this._headersClass});if(!r)return null;this._warcHeadersLength=this._reader.getReadOffset();let n=new p({warcHeaders:r,reader:this._initRecordReader(r)});if(this._record=n,this._parseHttp)switch(n.warcType){case"response":case"request":await this._addHttpHeaders(n,t);break;case"revisit":n.warcContentLength>0&&await this._addHttpHeaders(n,t);break}return n}get offset(){return this._offset}get recordLength(){return this._reader.getRawLength(this._offset)}async*[Symbol.asyncIterator](){let s=null;for(;(s=await this.parse())!==null;)yield s;this._record=null}async _addHttpHeaders(s,e){let t=await e.parse(this._reader,{headersClass:this._headersClass});s.httpHeaders=t;let r=this._reader.getReadOffset()-this._warcHeadersLength;s.reader instanceof m&&s.reader.setLimitSkip(s.warcContentLength-r)}};var ae=T(require("base32-encode"),1),ie=T(require("pako"),1);var ne=new TextEncoder,A=class extends h{constructor(e,t={}){super();this.gzip=!1;this.digestAlgo="";this.digestAlgoPrefix="";this.digestBase32=!1;this.record=e,this.gzip=Boolean(t.gzip);let r=t&&t.digest||{};e.warcType!=="revisit"&&e.warcType!=="warcinfo"&&(!e.warcPayloadDigest||!e.warcBlockDigest)?(this.digestAlgo=r?.algo||"sha-256",this.digestAlgoPrefix=r?.prefix||"sha256:",this.digestBase32=Boolean(r?.base32)):this.digestAlgo=""}static async serialize(e,t){return await new A(e,t).readFully()}static base16(e){return Array.from(new Uint8Array(e)).map(r=>r.toString(16).padStart(2,"0")).join("")}async*[Symbol.asyncIterator](){if(!this.gzip){yield*this.generateRecord();return}let e=null;"CompressionStream"in globalThis?(e=new globalThis.CompressionStream("gzip"),yield*this.streamCompress(e)):yield*this.pakoCompress()}async readlineRaw(e){return null}async*pakoCompress(){let e=new ie.default.Deflate({gzip:!0}),t=null;for await(let r of this.generateRecord())for(t&&t.length>0&&e.push(t),t=r;e.chunks.length;)yield e.chunks.shift();t&&e.push(t,!0),yield e.result}async*streamCompress(e){let t=this.generateRecord();new ReadableStream({async pull(o){let l=await t.next();l.done?o.close():o.enqueue(l.value)}}).pipeThrough(e);let n=null,i=e.readable.getReader();for(;(n=await i.read())&&!n.done;)yield n.value}async digestMessage(e){let t=await crypto.subtle.digest(this.digestAlgo,e);return this.digestAlgoPrefix+(this.digestBase32?(0,ae.default)(t,"RFC4648"):A.base16(t))}async*generateRecord(){let e=0,t=null;this.record.httpHeaders&&(t=ne.encode(this.record.httpHeaders.toString()+`\r
`),e+=t.length);let r=await this.record.readFully();if(e+=r.length,this.digestAlgo){let i=await this.digestMessage(r),o=t?await this.digestMessage(f([t,r],e)):i;this.record.warcHeaders.headers.set("WARC-Payload-Digest",i),this.record.warcHeaders.headers.set("WARC-Block-Digest",o)}this.record.warcHeaders.headers.set("Content-Length",e.toString()),yield ne.encode(this.record.warcHeaders.toString()),yield v,t&&(yield t),yield r,yield M}};var le=T(require("base32-encode"),1),k=require("hash-wasm");var oe=new TextEncoder,D=class{async write(s){}async*readAll(){}},B=class extends A{constructor(e,t,r={}){super(e,r);this.blockHasher=null;this.payloadHasher=null;this.httpHeadersBuff=null;this.warcHeadersBuff=null;this.recordbuffer=t,this.warcHeadersBuff=null,this.httpHeadersBuff=null}getDigest(e){return this.digestAlgoPrefix+(this.digestBase32?(0,le.default)(e.digest("binary"),"RFC4648"):e.digest("hex"))}async bufferRecord(e,t){let r=0;this.digestAlgo==="sha-256"?(this.blockHasher=await(0,k.createSHA256)(),this.payloadHasher=await(0,k.createSHA256)()):(this.blockHasher=await(0,k.createSHA1)(),this.payloadHasher=await(0,k.createSHA1)()),this.blockHasher?.init(),this.payloadHasher?.init(),e.httpHeaders&&(this.httpHeadersBuff=oe.encode(e.httpHeaders.toString()+`\r
`),r+=this.httpHeadersBuff.length,this.blockHasher?.update(this.httpHeadersBuff));for await(let n of e)this.blockHasher?.update(n),this.payloadHasher?.update(n),await t.write(n),r+=n.length;for await(let n of e)this.blockHasher?.update(n),this.payloadHasher?.update(n),await this.recordbuffer.write(n),r+=n.length;this.payloadHasher&&e.warcHeaders.headers.set("WARC-Payload-Digest",this.getDigest(this.payloadHasher)),this.blockHasher&&e.warcHeaders.headers.set("WARC-Block-Digest",this.getDigest(this.blockHasher)),e.warcHeaders.headers.set("Content-Length",r.toString()),this.warcHeadersBuff=oe.encode(e.warcHeaders.toString())}async*generateRecord(){this.warcHeadersBuff&&(yield this.warcHeadersBuff),yield v,this.httpHeadersBuff&&(yield this.httpHeadersBuff);for await(let e of this.recordbuffer.readAll())yield e;yield M}};var Ie=["offset","warc-type","warc-target-uri"],J=class{constructor(s={}){this.opts=s,this.fields=s&&s.fields?s.fields.split(","):Ie,this.parseHttp=!1}serialize(s){return JSON.stringify(s)+`
`}write(s,e){e.write(this.serialize(s))}async writeAll(s,e){for await(let t of this.iterIndex(s))this.write(t,e)}async*iterIndex(s){let e={strictHeaders:!0,parseHttp:this.parseHttp};for(let{filename:t,reader:r}of s){let n=new w(r,e);yield*this.iterRecords(n,t)}}async*iterRecords(s,e){for await(let t of s){await t.skipFully();let r=this.indexRecord(t,s,e);r&&(yield r)}}indexRecord(s,e,t){if(this.filterRecord&&!this.filterRecord(s))return null;let r={},n=e.offset,i=e.recordLength,o={offset:n,length:i,filename:t};for(let l of this.fields)l in o?r[l]=o[l]:this.setField(l,s,r);return r}setField(s,e,t){let r=this.getField(s,e);r!==null&&(t[s]=r)}getField(s,e){return s==="http:status"?e.httpHeaders&&(e.warcType==="response"||e.warcType==="revisit")?e.httpHeaders.statusCode:null:s.startsWith("http:")?e.httpHeaders?e.httpHeaders.headers.get(s.slice(5)):null:e.warcHeaders.headers.get(s)||null}},H=class extends J{constructor(s){super(s);for(let e of this.fields)if(e.startsWith("http:")){this.parseHttp=!0;break}}},Te="urlkey,timestamp,url,mime,status,digest,length,offset,filename".split(","),Ue="urlkey,timestamp,url,mime,status,digest,redirect,meta,length,offset,filename".split(","),W=class extends H{constructor(e){super(e);switch(this.includeAll=Boolean(e?.all),this.overrideIndexForAll=Boolean(e?.all),this.fields=Te,this.parseHttp=!0,this.noSurt=Boolean(e?.noSurt),this._lastRecord=null,e?.format){case"cdxj":this.serialize=this.serializeCDXJ;break;case"cdx":this.serialize=this.serializeCDX11;break;case"json":default:break}}async*iterRecords(e,t){this._lastRecord=null;for await(let n of e){await n.readFully();let i=this.indexRecord(n,e,t);i&&(yield i)}let r=this.indexRecord(null,e,t);r&&(yield r)}filterRecord(e){if(this.includeAll)return!0;let t=e.warcType;return!(t==="request"||t==="warcinfo"||(t==="metadata"||t==="resource")&&e.warcContentType==="application/warc-fields")}indexRecord(e,t,r){if(this.overrideIndexForAll)return e?super.indexRecord(e,t,r):null;let n=this._lastRecord;if(this._lastRecord=e,e&&(e._offset=t.offset,e._length=t.recordLength),!n)return null;if(!e||n.warcTargetURI!=e.warcTargetURI)return this.indexRecordPair(n,null,t,r);let i=e.warcType,o=n.warcType;return i==="request"&&(o==="response"||o==="revisit")?(this._lastRecord=null,this.indexRecordPair(n,e,t,r)):(i==="response"||i==="revisit")&&o==="request"?(this._lastRecord=null,this.indexRecordPair(e,n,t,r)):this.indexRecordPair(n,null,t,r)}indexRecordPair(e,t,r,n){let i,o,l=e.warcTargetURI||"";if(t&&t.httpHeaders&&t.httpHeaders.method!=="GET"){let y={url:l,method:t.httpHeaders.method,headers:t.httpHeaders.headers,postData:t.payload};i=y.method,P(y)&&(o=y.requestBody,e.method=i,e.requestBody=o,l=y.url)}e._urlkey=l;let d=super.indexRecord(e,r,n);return d&&(e&&e._offset!==void 0&&(d.offset=e._offset,d.length=e._length),i&&(d.method=i),o&&(d.requestBody=o)),d}serializeCDXJ(e){let{urlkey:t,timestamp:r}=e;return delete e.urlkey,delete e.timestamp,`${t} ${r} ${JSON.stringify(e)}
`}serializeCDX11(e){let t=[];for(let r of Ue)t.push(e[r]!=null?e[r]:"-");return t.join(" ")+`
`}getField(e,t){let r=null;switch(e){case"urlkey":return r=t._urlkey||t.warcTargetURI||null,this.noSurt||r===null?r:L(r);case"timestamp":return r=t.warcDate??"",r.replace(/[-:T]/g,"").slice(0,14);case"url":return t.warcTargetURI;case"mime":switch(t.warcType){case"revisit":return"warc/revisit";case"response":case"request":e="http:content-type";break;default:e="content-type"}return r=super.getField(e,t),r?r.toString().split(";",1)[0]?.trim():null;case"status":return super.getField("http:status",t);case"digest":return r=t.warcPayloadDigest,r?r.split(":",2)[1]:null;default:return null}}},F=class extends W{constructor(s){super(s),this.overrideIndexForAll=!1}indexRecordPair(s,e,t,r){let n=super.indexRecordPair(s,e,t,r);return n&&{cdx:n,record:s,reqRecord:e}}};0&&(module.exports={AsyncIterReader,BaseAsyncIterReader,CDXAndRecordIndexer,CDXIndexer,Indexer,LimitReader,NoConcatInflator,StatusAndHeaders,StatusAndHeadersParser,StreamingWARCSerializer,WARCParser,WARCRecord,WARCRecordBuffer,WARCSerializer,WARC_1_0,WARC_1_1,appendRequestQuery,concatChunks,getSurt,jsonToQueryParams,jsonToQueryString,mfdToQueryParams,mfdToQueryString,postToGetUrl,splitChunk});
