"use strict";var D=Object.create;var g=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var M=Object.getPrototypeOf,V=Object.prototype.hasOwnProperty;var q=(s,n)=>{for(var e in n)g(s,e,{get:n[e],enumerable:!0})},I=(s,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of N(n))!V.call(s,r)&&r!==e&&g(s,r,{get:()=>n[r],enumerable:!(t=W(n,r))||t.enumerable});return s};var k=(s,n,e)=>(e=s!=null?D(M(s)):{},I(n||!s||!s.__esModule?g(e,"default",{value:s,enumerable:!0}):e,s)),$=s=>I(g({},"__esModule",{value:!0}),s);var j={};q(j,{DEFAULT_MEM_SIZE:()=>R,TempFileBuffer:()=>m,WARCSerializer:()=>A});module.exports=$(j);var U=k(require("fs"),1),F=require("fs/promises"),O=require("tempy");function S(s){if(s instanceof Int8Array||s instanceof Uint8Array||s instanceof Uint8ClampedArray)return new DataView(s.buffer,s.byteOffset,s.byteLength);if(s instanceof ArrayBuffer)return new DataView(s);throw new TypeError("Expected `data` to be an ArrayBuffer, Buffer, Int8Array, Uint8Array or Uint8ClampedArray")}var Q="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",G="0123456789ABCDEFGHIJKLMNOPQRSTUV",K="0123456789ABCDEFGHJKMNPQRSTVWXYZ";function C(s,n,e){e=e||{};let t,r;switch(n){case"RFC3548":case"RFC4648":t=Q,r=!0;break;case"RFC4648-HEX":t=G,r=!0;break;case"Crockford":t=K,r=!1;break;default:throw new Error("Unknown base32 variant: "+n)}let i=e.padding!==void 0?e.padding:r,o=S(s),a=0,l=0,f="";for(let x=0;x<o.byteLength;x++)for(l=l<<8|o.getUint8(x),a+=8;a>=5;)f+=t[l>>>a-5&31],a-=5;if(a>0&&(f+=t[l<<5-a&31]),i)for(;f.length%8!==0;)f+="=";return f}var E=k(require("pako"),1),y=require("hash-wasm");var B=k(require("pako"),1);function w(s,n){if(s.length===1)return s[0];let e=new Uint8Array(n),t=0;for(let r of s)e.set(r,t),t+=r.byteLength;return e}function d(s,n){return[s.slice(0,n),s.slice(n)]}var L=new TextDecoder("utf-8"),p=class extends B.default.Inflate{constructor(e,t){super(e);this.ended=!1;this.chunks=[];this.reader=t}onEnd(e){this.err=e,this.err||(this.reader._rawOffset+=this.strm.total_in)}},c=class s{static async readFully(n){let e=[],t=0;for await(let r of n)e.push(r),t+=r.byteLength;return w(e,t)}getReadableStream(){let n=this[Symbol.asyncIterator]();return new ReadableStream({pull(e){return n.next().then(t=>{t.done||!t.value?e.close():e.enqueue(t.value)})}})}async readFully(){return await s.readFully(this)}async readline(n=0){let e=await this.readlineRaw(n);return e?L.decode(e):""}async*iterLines(n=0){let e=null;for(;e=await this.readline(n);)yield e}};function J(s){return s&&Symbol.iterator in Object(s)}function X(s){return s&&Symbol.asyncIterator in Object(s)}var z=class s extends c{constructor(e,t="gzip",r=!1){super();this.compressed=t,this.opts={raw:t==="deflateRaw"},this.inflator=t?new p(this.opts,this):null;let i;if(X(e))i=e;else if(typeof e=="object"&&"read"in e&&typeof e.read=="function")i=s.fromReadable(e);else if(e instanceof ReadableStream)i=s.fromReadable(e.getReader());else if(J(e))i=s.fromIter(e);else throw new TypeError("Invalid Stream Source");r?this._sourceIter=this.dechunk(i):this._sourceIter=i[Symbol.asyncIterator](),this.lastValue=null,this.errored=!1,this._savedChunk=null,this._rawOffset=0,this._readOffset=0,this.numChunks=0}async _loadNext(){let e=await this._sourceIter.next();return e.done?null:e.value}async*dechunk(e){let t=e instanceof s?e:new s(e,null),r=-1,i=!0;for(;r!=0;){let o=await t.readlineRaw(64),a=new Uint8Array;if(r=o?parseInt(L.decode(o),16):0,!r||r>2**32){if(Number.isNaN(r)||r>2**32){i||(this.errored=!0),yield o;break}}else if(a=await t.readSize(r),a.length!=r){i?yield o:this.errored=!0,yield a;break}let l=await t.readSize(2);if(l[0]!=13||l[1]!=10){i?yield o:this.errored=!0,yield a,yield l;break}else{if(i=!1,!a||r===0)return;yield a}}yield*t}unread(e){e.length&&(this._readOffset-=e.length,this._savedChunk&&console.log("Already have chunk!"),this._savedChunk=e)}async _next(){if(this._savedChunk){let t=this._savedChunk;return this._savedChunk=null,t}if(this.compressed){let t=this._getNextChunk();if(t)return t}let e=await this._loadNext();for(;this.compressed&&e;){this._push(e);let t=this._getNextChunk(e);if(t)return t;e=await this._loadNext()}return e}_push(e){if(!this.inflator)throw new Error("AsyncIterReader cannot call _push when this.compressed is null");this.lastValue=e,this.inflator.ended&&(this.inflator=new p(this.opts,this)),this.inflator.push(e),this.inflator.err&&this.inflator.ended&&this.compressed==="deflate"&&this.opts.raw===!1&&this.numChunks===0&&(this.opts.raw=!0,this.compressed="deflateRaw",this.inflator=new p(this.opts,this),this.inflator.push(e))}_getNextChunk(e){if(!this.inflator)throw new Error("AsyncIterReader cannot call _getNextChunk when this.compressed is null");for(;;){if(this.inflator.chunks.length>0)return this.numChunks++,this.inflator.chunks.shift();if(this.inflator.ended){if(this.inflator.err!==0)return this.compressed=null,e;let t=this.inflator.strm.avail_in;if(t&&this.lastValue){this._push(this.lastValue.slice(-t));continue}}return null}}async*[Symbol.asyncIterator](){let e=null;for(;e=await this._next();)this._readOffset+=e.length,yield e}async readlineRaw(e){let t=[],r=0,i=-1,o=null;for await(let a of this){if(e&&r+a.byteLength>e){o=a,i=e-r-1;let l=a.slice(0,i+1).indexOf(10);l>=0&&(i=l);break}if(i=a.indexOf(10),i>=0){o=a;break}t.push(a),r+=a.byteLength}if(o){let[a,l]=d(o,i+1);t.push(a),r+=a.byteLength,this.unread(l)}else if(!t.length)return null;return w(t,r)}async readFully(){return(await this._readOrSkip())[1]}async readSize(e){return(await this._readOrSkip(e))[1]}async skipSize(e){return(await this._readOrSkip(e,!0))[0]}async _readOrSkip(e=-1,t=!1){let r=[],i=0;for await(let o of this){if(e>=0)if(o.length>e){let[a,l]=d(o,e);t||r.push(a),i+=a.byteLength,this.unread(l);break}else if(o.length===e){t||r.push(o),i+=o.byteLength,e=0;break}else e-=o.length;t||r.push(o),i+=o.byteLength}return t?[i,new Uint8Array]:[i,w(r,i)]}getReadOffset(){return this._readOffset}getRawOffset(){return this.compressed?this._rawOffset:this._readOffset}getRawLength(e){return this.compressed?this.inflator.strm.total_in:this._readOffset-e}static fromReadable(e){return{async*[Symbol.asyncIterator](){let r=null;for(;(r=await e.read())&&!r.done;)yield r.value}}}static fromIter(e){return{async*[Symbol.asyncIterator](){for(let r of e)yield r}}}},v=class extends c{constructor(e,t,r=0){super();this.sourceIter=e,this.length=t,this.limit=t,this.skip=r}setLimitSkip(e,t=0){this.limit=e,this.skip=t}async*[Symbol.asyncIterator](){if(!(this.limit<=0))for await(let e of this.sourceIter){if(this.skip>0)if(e.length>=this.skip){let[,t]=d(e,this.skip);e=t,this.skip=0}else{this.skip-=e.length;continue}if(e.length>this.limit){let[t,r]=d(e,this.limit);e=t,this.sourceIter.unread&&this.sourceIter.unread(r)}if(e.length&&(this.limit-=e.length,yield e),this.limit<=0)break}}async readlineRaw(e){if(this.limit<=0)return null;let t=await this.sourceIter.readlineRaw(e?Math.min(e,this.limit):this.limit);return this.limit-=t?.length||0,t}async skipFully(){let e=this.limit;for(;this.limit>0;)this.limit-=await this.sourceIter.skipSize(this.limit);return e}};var H=new Uint8Array([13,10]),T=new Uint8Array([13,10,13,10]),he=new TextDecoder("utf-8");var P=new TextEncoder,_=class{},h=class extends _{constructor(){super(...arguments);this.buffers=[]}write(e){this.buffers.push(e)}async*readAll(){for(let e of this.buffers)yield e}},b=class s extends c{constructor(e,t={},r=new h){super();this.gzip=!1;this.digestAlgo="";this.digestAlgoPrefix="";this.digestBase32=!1;this.preferPako=!1;this._alreadyDigested=!1;this.blockHasher=null;this.payloadHasher=null;this.httpHeadersBuff=null;this.warcHeadersBuff=null;this.gzip=!!t.gzip,this.record=e;let i=t&&t.digest||{};this.digestAlgo=i?.algo||"sha-256",this.digestAlgoPrefix=i?.prefix||"sha256:",this.digestBase32=!!i?.base32,this.preferPako=!!t?.preferPako,s.noComputeDigest(e)&&(this.digestAlgo=""),this.externalBuffer=r}static async serialize(e,t,r=new h){return await new s(e,t,r).readFully()}static noComputeDigest(e){return e.warcType==="revisit"||e.warcType==="warcinfo"||e.warcPayloadDigest&&e.warcBlockDigest}async*[Symbol.asyncIterator](){if(!this.gzip){yield*this.generateRecord();return}if("CompressionStream"in globalThis&&!this.preferPako){let e=new globalThis.CompressionStream("gzip");yield*this.streamCompress(e)}else yield*this.pakoCompress()}async readlineRaw(e){return null}async*pakoCompress(){let e=new E.default.Deflate({gzip:!0}),t=null;for await(let r of this.generateRecord())for(t&&t.length>0&&e.push(t),t=r;e.chunks.length;)yield e.chunks.shift();t&&e.push(t,!0),yield e.result}async*streamCompress(e){let t=this.generateRecord();new ReadableStream({async pull(a){let l=await t.next();l.done?a.close():a.enqueue(l.value)}}).pipeThrough(e);let i=null,o=e.readable.getReader();for(;(i=await o.read())&&!i.done;)yield i.value}newHasher(){switch(this.digestAlgo){case"sha-256":return(0,y.createSHA256)();case"sha-1":return(0,y.createSHA1)();case"":return null;default:return(0,y.createSHA256)()}}getDigest(e){return this.digestAlgoPrefix+(this.digestBase32?C(e.digest("binary"),"RFC4648"):e.digest("hex"))}async digestRecord(){let e=this.record;if(this._alreadyDigested)return Number(e.warcHeaders.headers.get("Content-Length"));let t=await this.newHasher(),r=await this.newHasher(),i=0;e.httpHeaders&&(this.httpHeadersBuff=P.encode(e.httpHeaders.toString()+`\r
`),i+=this.httpHeadersBuff.length,t?.update(this.httpHeadersBuff));for await(let o of e.reader)t?.update(o),r?.update(o),await this.externalBuffer.write(o),i+=o.length;return r&&e.warcHeaders.headers.set("WARC-Payload-Digest",this.getDigest(r)),t&&e.warcHeaders.headers.set("WARC-Block-Digest",this.getDigest(t)),e.warcHeaders.headers.set("Content-Length",i.toString()),this.warcHeadersBuff=P.encode(e.warcHeaders.toString()),this._alreadyDigested=!0,i}async*generateRecord(){if(await this.digestRecord(),this.warcHeadersBuff&&(yield this.warcHeadersBuff),yield H,this.httpHeadersBuff&&(yield this.httpHeadersBuff),this.externalBuffer)for await(let e of this.externalBuffer.readAll())yield e;yield T}};var R=1024*1024*2,A=class s extends b{static async serialize(n,e){return await new s(n,e).readFully()}constructor(n,e={}){super(n,e,new m(e.maxMemSize||R))}},m=class extends h{constructor(e=R){super();this.currSize=0;this.fh=null;this.filename="";this.memSize=e}write(e){this.currSize+e.length<=this.memSize?this.buffers.push(e):(this.fh||(this.filename=(0,O.temporaryFile)(),this.fh=U.default.createWriteStream(this.filename)),this.fh.write(e)),this.currSize+=e.length}async*readAll(){for(let t of this.buffers)yield t;if(!this.fh)return;await Y(this.fh),this.fh=null;let e=U.default.createReadStream(this.filename);for await(let t of e)yield t;await(0,F.unlink)(this.filename)}};function Y(s){let n=new Promise(e=>{s.once("finish",()=>e())});return s.end(),n}0&&(module.exports={DEFAULT_MEM_SIZE,TempFileBuffer,WARCSerializer});
